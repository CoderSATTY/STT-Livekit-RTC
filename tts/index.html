<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>Chatterbox Turbo Stream</title>
    <style>
        body { font-family: sans-serif; max-width: 800px; margin: 2rem auto; padding: 0 1rem; background: #f4f4f9; }
        .container { background: white; padding: 2rem; border-radius: 8px; box-shadow: 0 2px 5px rgba(0,0,0,0.1); }
        textarea { width: 100%; height: 100px; padding: 10px; margin-bottom: 10px; border-radius: 4px; border: 1px solid #ddd; }
        button { background: #007bff; color: white; border: none; padding: 10px 20px; cursor: pointer; border-radius: 4px; font-size: 16px; }
        button:hover { background: #0056b3; }
        #status { margin-top: 10px; color: #666; font-style: italic; }
    </style>
</head>
<body>
    <div class="container">
        <h2>Chatterbox Turbo Live</h2>
        <p>Type text below. The audio will stream chunk-by-chunk.</p>
        
        <textarea id="inputText" placeholder="Enter a long text here to test streaming..."></textarea>
        <button onclick="sendText()">Speak</button>
        <div id="status">Ready</div>
    </div>

    <script>
        let socket;
        let audioContext;
        let nextStartTime = 0;

        function initWebSocket() {
            // Connect to the websocket on the same host
            const protocol = window.location.protocol === 'https:' ? 'wss:' : 'ws:';
            socket = new WebSocket(`${protocol}//${window.location.host}/ws`);

            socket.onopen = () => {
                document.getElementById("status").innerText = "Connected to Server";
            };

            socket.onmessage = async (event) => {
                const data = JSON.parse(event.data);
                const audioData = data.audio;
                const sampleRate = data.sample_rate;

                document.getElementById("status").innerText = `Receiving chunk ${data.chunk_id}...`;
                
                await playChunk(audioData, sampleRate);

                if (data.is_last) {
                    document.getElementById("status").innerText = "Finished receiving.";
                }
            };

            socket.onclose = () => {
                document.getElementById("status").innerText = "Disconnected. Refresh to reconnect.";
            };
        }

        async function playChunk(base64Data, sampleRate) {
            // 1. Initialize AudioContext on first user interaction
            if (!audioContext) {
                audioContext = new (window.AudioContext || window.webkitAudioContext)({ sampleRate: sampleRate });
            }

            // 2. Decode Base64 to Float32 Array
            const binaryString = atob(base64Data);
            const len = binaryString.length;
            const bytes = new Uint8Array(len);
            for (let i = 0; i < len; i++) {
                bytes[i] = binaryString.charCodeAt(i);
            }
            // Create a view to interpret the bytes as Float32
            const float32Data = new Float32Array(bytes.buffer);

            // 3. Create Audio Buffer
            const audioBuffer = audioContext.createBuffer(1, float32Data.length, sampleRate);
            audioBuffer.getChannelData(0).set(float32Data);

            // 4. Schedule Playback
            const source = audioContext.createBufferSource();
            source.buffer = audioBuffer;
            source.connect(audioContext.destination);

            // Ensure we schedule this chunk to play AFTER the previous one finishes
            // If nextStartTime is in the past (pipeline ran dry), reset it to 'now'
            if (nextStartTime < audioContext.currentTime) {
                nextStartTime = audioContext.currentTime;
            }

            source.start(nextStartTime);

            // Advance time for the next chunk
            nextStartTime += audioBuffer.duration;
        }

        function sendText() {
            const text = document.getElementById("inputText").value;
            if (!text) return;
            
            // Reset timing for new utterance
            if(audioContext) nextStartTime = audioContext.currentTime;
            
            socket.send(text);
        }

        // Initialize connection on load
        window.onload = initWebSocket;
    </script>
</body>
</html>